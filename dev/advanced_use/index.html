<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced usage · Sensemakr.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://d2cml-ai.github.io/Sensemakr.jl/advanced_use/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Sensemakr.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Quickstart</a></li><li class="is-active"><a class="tocitem" href>Advanced usage</a><ul class="internal"><li><a class="tocitem" href="#The-risks-of-informal-benchmarking"><span>The risks of informal benchmarking</span></a></li><li><a class="tocitem" href="#Manually-providing-input-data"><span>Manually providing input data</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced usage</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced usage</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Advanced-usage"><a class="docs-heading-anchor" href="#Advanced-usage">Advanced usage</a><a id="Advanced-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-usage" title="Permalink"></a></h1><p>The standard functionality of the <code>Sensemakr</code>, demonstrated in the previous section, will suﬃce for most users, most of the time. When needed, more ﬂexibility can be obtained by employing the sensitivity functions of the package directly, such as: (i) functions for sensitivity plots (<code>ovb_contour_plot</code>, <code>ovb_extreme_plot</code>); (ii) functions for computing bias-adjusted estimates and t-values (<code>adjusted_estimate</code>, <code>adjusted_t</code>); (iii) functions for computing the robustness value and partial R2 directly (<code>robustness_value</code>, <code>partial_r2</code>); and, (iv) functions for bounding the strength of unobserved confounders (<code>ovb_bounds</code>), among others. These functions are automatically imported when loading the package.</p><p>In this page we demonstrate how to use these functions in two examples.</p><h2 id="The-risks-of-informal-benchmarking"><a class="docs-heading-anchor" href="#The-risks-of-informal-benchmarking">The risks of informal benchmarking</a><a id="The-risks-of-informal-benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#The-risks-of-informal-benchmarking" title="Permalink"></a></h2><p>Informal “benchmarking” procedures have been widely suggested in the sensitivity analysis literature as a means to aid interpretation. It intends to describe how an unobserved confounder <span>$Z$</span> “not unlike” some observed covariate <span>$X_j$</span> would alter the results of a study. <a href="https://doi.org/10.1111/rssb.12348">Cinelli and Hazlett (2020)</a> show why these proposals may lead users to erroneous conclusions, and offer formal bounds on the bias that could be produced by unobserved confounding “as strong” as certain observed covariates.</p><p>Here we use <code>Sensemakr</code> to replicate the example in Section 6.1 of <a href="https://doi.org/10.1111/rssb.12348">Cinelli and Hazlett (2020)</a>. This example provides a useful tutorial on how users can construct their own sensitivity contour plots with customized bounds, beyond what is offered by default on the package.</p><h3 id="Simulating-the-data"><a class="docs-heading-anchor" href="#Simulating-the-data">Simulating the data</a><a id="Simulating-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-data" title="Permalink"></a></h3><p>We begin by simulating the data generating process used in our example. Consider a treatment variable <span>$D$</span>, an outcome variable <span>$Y$</span>, one observed confounder <span>$X$</span>, and one unobserved confounder <span>$Z$</span>. Again, all disturbance variables <span>$U$</span> are standardized mutually independent gaussians, and note that, in reality, the treatment <span>$D$</span> has no causal effect on the outcome <span>$Y$</span>.</p>$<p>Z = U<em>z \
X = U</em>x \
D = X + Z + U<em>d \
Y = X + Z + U</em>y $</p><p>Also note that, in this model: (i) the unobserved confounder <code>Z</code> is independent of <code>X</code>; and, (ii) the unobserved confounder <code>Z</code> is exactly like <code>X</code> in terms of its strength of association with the treatment and the outcome. The code below creates a sample of size 100 of this data generating process. We make sure to create residuals that are standardized and orthogonal so that all properties that we describe here will hold exactly even in this finite sample.</p><pre><code class="language-julia hljs"># loads GLM, DataFrames, and Statistics
using GLM, DataFrames, Statistics

# defines function to simulate orthogonal residuals
function resid_maker(n, df)
    N = randn(n)
    form = Term(:N) ~ sum(term.(propertynames(df)))
    df[:, &quot;N&quot;] = N
    model = lm(form, df)
    e = residuals(model)
    e = (e .- mean(e)) / std(e)
    return e
end;

# simulates data
n = 100;
X = randn(n);
X = (X .- mean(X)) / std(X);
Z = resid_maker(n, DataFrame(x = X));
D = X + Z + resid_maker(n, DataFrame(x = X, z = Z));
Y = X + Z + resid_maker(n, DataFrame(x = X, z = Z, d = D));</code></pre><h3 id="Fitting-the-model"><a class="docs-heading-anchor" href="#Fitting-the-model">Fitting the model</a><a id="Fitting-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-the-model" title="Permalink"></a></h3><p>In this example, the investigator does not observe the confounder <span>$Z$</span>. Therefore, she is forced to fit the restricted linear model <span>$Y \sim D + X$</span>, resulting in the following estimated values</p><pre><code class="language-julia hljs"># creates DataFrame with the data
df = DataFrame(Y = Y, X = X, Z = Z, D = D);

# runs OLS
model_ydx = lm(@formula(Y ~ D + X), df);

# print OLS table
println(coeftable(model_ydx))

# print R2
println(r2(model_ydx))</code></pre><pre><code class="nohighlight hljs">──────────────────────────────────────────────────────────────────────────
                   Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
──────────────────────────────────────────────────────────────────────────
(Intercept)  3.05311e-17   0.123731   0.00    1.0000  -0.245571   0.245571
D            0.5           0.0879316  5.69    &lt;1e-06   0.32548    0.67452
X            0.5           0.152302   3.28    0.0014   0.197723   0.802277
──────────────────────────────────────────────────────────────────────────
0.5
</code></pre><p>Note we obtain a large and statistically significant coefficient estimate of the effect of <span>$X$</span> on <span>$Y$</span> (<span>$0.5$</span>). However, we know that the variable <span>$Z$</span> is not observed, and there is the fear that this estimated effect is in fact due to the bias caused by <span>$Z$</span>. On the other hand, let us suppose the investigator correctly knows that: (i) Z and X have the same strength of association with <span>$D$</span> and <span>$Y$</span>; and, (ii) <span>$Z$</span> is independent of <span>$X$</span>. Can we leverage this information to understand how much bias a confounder <span>$Z$</span> “not unlike” <span>$X$</span> could cause?</p><h3 id="Informal-benchmarks"><a class="docs-heading-anchor" href="#Informal-benchmarks">Informal benchmarks</a><a id="Informal-benchmarks-1"></a><a class="docs-heading-anchor-permalink" href="#Informal-benchmarks" title="Permalink"></a></h3><p>Computing the bias due to the omission of <span>$Z$</span> requires two sensitivity parameters: its partial <span>$R^2$</span> with the treatment <span>$D$</span> and its partial <span>$R^2$</span> with the outcome <span>$Y$</span>. How could we go about computing the bias that a confounder <span>$Z$</span> “not unlike X” would cause?</p><p>Intuitively, it seems that we could take as reference the observed partial <span>$R^2$</span> of <span>$X$</span> with <span>$D$</span> and <span>$Y$</span>, and use those as the plausible values for the sensitivity parameters. So let us now compute those observed partial <span>$R^2$</span> using the <code>partial_r2()</code>. For the partial <span>$R^2$</span> of <span>$X$</span> with the treatment, we also need to fit a treatment regression <span>$D \sim X$</span> first.</p><pre><code class="language-julia hljs"># load Sensemakr
using Sensemakr

# fits treatment regression
model_dx = lm(@formula(D ~ X), df);

# computes partial R2 of X with D and Y
r2dx = partial_r2(model = model_dx, covariates = &quot;X&quot;);
r2yx_d = partial_r2(model = model_ydx, covariates = &quot;X&quot;);</code></pre><p>Once both partial <span>$R^2$</span> are computed, we can determine the implied adjusted estimate due to an unobserved confounder <span>$Z$</span> using the <code>adjusted_estimate()</code>.</p><pre><code class="language-julia hljs"># computes adjusted estimate
informal_adjusted_estimate = adjusted_estimate(r2dx, r2yx_d, model = model_ydx, treatment = &quot;D&quot;);</code></pre><p>We can now plot the sensitivity contours with <code>ovb_contour_plot()</code> and add our informal benchmark with <code>add_bound_to_contour()</code>.</p><pre><code class="language-julia hljs"># draws sensitivity contours
ovb_contour_plot(model_ydx, &quot;D&quot;, lim = 0.6)

# adds informal benchmark
add_bound_to_contour(r2dx, r2yx_d, bound_value = informal_adjusted_estimate, bound_label = [&quot;Informal benchmark&quot;], label_bump_x = 0.6/30, label_bump_y = 0.6/30)</code></pre><p><img src="../images/Figure_4.png" alt="Figure_4"/></p><p>As we can see, the results of the informal benchmark are different from what we expected. The informal benchmark point is still far away from zero, and this would lead an investigator to incorrectly conclude that an unobserved confounder <span>$Z$</span> “not unlike <span>$X$</span>” is not sufficient to explain away the observed effect. Moreover, this incorrect conclusion occurs despite correctly assuming that: (i) <span>$Z$</span> and <span>$X$</span> have the same strength of association with <span>$D$</span> and <span>$Y$</span>; and, (ii) <span>$Z$</span> is independent of <span>$X$</span>. See Section 6.1 of <a href="https://doi.org/10.1111/rssb.12348">Cinelli and Hazlett (2020)</a> for details of why this happens.</p><h3 id="Formal-Bounds"><a class="docs-heading-anchor" href="#Formal-Bounds">Formal Bounds</a><a id="Formal-Bounds-1"></a><a class="docs-heading-anchor-permalink" href="#Formal-Bounds" title="Permalink"></a></h3><p>We now show how to compute formal bounds using the function <code>ovb_bounds()</code>.</p><pre><code class="language-julia hljs"># computes formal bounds
formal_bound = ovb_bounds(model_ydx, &quot;D&quot;, benchmark_covariates = &quot;X&quot;, kd = 1, ky = 1);</code></pre><p>In this function we specify the linear model being used (<code>model_ydx</code>), the treatment of interest (<span>$D$</span>), the observed variable used for benchmarking (<span>$X$</span>), and how stronger <span>$Z$</span> is in explaining treatment (<code>kd</code>) and outcome (<code>ky</code>) variation, as compared to the benchmark variable <span>$X$</span>. We can now plot the proper bound against the informal benchmark.</p><pre><code class="language-julia hljs"># contour plot contrasting informal vs formal bounds
ovb_contour_plot(model_ydx, &quot;D&quot;, lim = 0.6)
add_bound_to_contour(r2dx, r2yx_d, bound_value = informal_adjusted_estimate, bound_label = [&quot;Informal benchmark&quot;], label_bump_x = 0.6/30, label_bump_y = 0.6/30)
add_bound_to_contour(formal_bound, bound_label = [&quot;Proper bound&quot;], label_bump_x = 0.6/30, label_bump_y = 0.6/30)</code></pre><p><img src="../images/Figure_5.png" alt="Figure_5"/></p><p>Note that, using the formal bounds, the researcher now reaches the correct conclusion that, an unobserved confounder <span>$Z$</span> similar to <span>$X$</span> is strong enough to explain away all the observed association.</p><h2 id="Manually-providing-input-data"><a class="docs-heading-anchor" href="#Manually-providing-input-data">Manually providing input data</a><a id="Manually-providing-input-data-1"></a><a class="docs-heading-anchor-permalink" href="#Manually-providing-input-data" title="Permalink"></a></h2><p>We now demonstrate how to replicate the sensitivity analysis of the Darfur example (see Quickstart) without access to the microdata, using only usual statistics found in the regression tables. All results of the Darfur example, except the formal benchmark bounds as we explaim below, can be recoverded by simply providing: (i) the point estimate of <code>directlyharmed</code> (<span>$0.097$</span>); (ii) its estimated standard error (<span>$0.023$</span>); and, (iii) the degrees of freedom of the regression (<span>$783$</span>). This type of “manual” analysis can be useful when reading or reviewing papers that did not perform sensitivity.</p><pre><code class="language-julia hljs"># computes the robustness value
robustness_value(t_statistic = 0.097 / 0.023, dof = 783)</code></pre><pre><code class="nohighlight hljs">1-element Vector{Float64}:
 0.1397867718266666</code></pre><pre><code class="language-julia hljs"># computes the partial R2
partial_r2(t_statistic = 0.097/0.023, dof = 783)</code></pre><pre><code class="nohighlight hljs">0.022211153497507175</code></pre><pre><code class="language-julia hljs"># computes what the adjusted estimate would have been
# after adjusting for confounders with strength r2dz_x = .1, r2yz_dx = 0.15
adjusted_estimate(0.1, 0.15, estimate = 0.097, se = 0.023, dof = 783)</code></pre><pre><code class="nohighlight hljs">0.013912997406333186</code></pre><pre><code class="language-julia hljs"># computes what the adjusted t-value would have been
# after adjusting for confounders with strength r2dz_x = .1, r2yz_dx = 0.15
adjusted_t(0.1, 0.15, estimate = 0.097, se = 0.023, dof = 783)</code></pre><pre><code class="nohighlight hljs">0.6220526656946492</code></pre><pre><code class="language-julia hljs"># contour plot of the point estimate
ovb_contour_plot(0.097, 0.023, 783)</code></pre><p><img src="../images/Figure_6.png" alt="Figure_6"/></p><pre><code class="language-julia hljs"># contour plot of the t-value
ovb_contour_plot(0.097, 0.023, 783, sensitivity_of = &quot;t-value&quot;)</code></pre><p><img src="../images/Figure_7.png" alt="Figure_7"/></p><pre><code class="language-julia hljs"># extreme plot
ovb_extreme_plot(0.097, 0.023, 783)</code></pre><p><img src="../images/Figure_8.png" alt="Figure_8"/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../quickstart/">« Quickstart</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 24 October 2022 20:08">Monday 24 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
